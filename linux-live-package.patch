--- linux-live-5.5.0/.config	2006-09-29 15:30:28.000000000 +0300
+++ linux-live-5.5.0/.config	2006-10-17 22:53:07.000000000 +0300
@@ -16,7 +16,8 @@
 
 # kernel version. Change it to "2.6.10" for example, if you are building
 # LiveCD with a different kernel than the one you are actually running
-KERNEL=$(uname -r)
+image=$(cd $ROOT; readlink boot/vmlinuz)
+KERNEL="${image#vmlinuz-}"
 
 # list of directories which will be modularized
 # You may add 'dev' inthere in the case your distro doesn't have udev installed
@@ -20,7 +20,7 @@
 
 # change this variable if you installed your distro to some directory.
 # for example ROOT=/tmp/newdir. You may leave it empty, then it defaults to /
-ROOT=
+#ROOT=
 
 # If the writable branch (used for changes) doesn't support symlinks or if it
 # doesn't handle chmod attributes well, overmount it using the posix overlay 
--- linux-live/build	2006-10-13 15:33:24.000000000 +0300
+++ linux-live-5.5.0/build	2006-10-13 18:25:50.000000000 +0300
@@ -10,8 +10,8 @@
 echo "Changing current directory to $CHANGEDIR"
 cd $CHANGEDIR
 
-. liblinuxlive || exit 1
-. ./.config || exit 1
+. /usr/lib/liblinuxlive || exit 1
+. /etc/linux-live/config || exit 1
 
 # only root can continue, because only root can read all files from your system
 allow_only_root
@@ -30,9 +30,9 @@
 # search for kernel
 VMLINUZ=$ROOT/boot/vmlinuz
 if [ -L "$VMLINUZ" ]; then VMLINUZ=$(readlink -f $VMLINUZ); fi
-echo -ne "Enter path for the kernel you'd like to use [hit enter for $VMLINUZ]: "
-read NEWKERNEL
-if [ "$NEWKERNEL" != "" ]; then VMLINUZ="$NEWKERNEL"; fi
+#echo -ne "Enter path for the kernel you'd like to use [hit enter for $VMLINUZ]: "
+#read NEWKERNEL
+#if [ "$NEWKERNEL" != "" ]; then VMLINUZ="$NEWKERNEL"; fi
 if [ "$(ls $VMLINUZ 2>>$DEBUG)" = "" ]; then echo "cannot find $VMLINUZ"; exit 1; fi
 
 header "Creating LiveCD from your Linux"
@@ -40,7 +40,11 @@
 
 mkdir -p $CDDATA/$LIVECDNAME
 cp -R cd-root/linux/* $CDDATA/$LIVECDNAME
-cp tools/* $CDDATA/$LIVECDNAME/tools
+cp /usr/bin/{deb2lzm,dir2lzm,lzm2dir,tgz2lzm} $CDDATA/$LIVECDNAME/tools
+cp /usr/lib/liblinuxlive $CDDATA/$LIVECDNAME/tools
+cp /usr/sbin/uselivemod $CDDATA/$LIVECDNAME/tools
+cp /sbin/mksquashfs $CDDATA/$LIVECDNAME/tools
+cp /sbin/unsquashfs $CDDATA/$LIVECDNAME/tools
 cp -R DOC/LICENSE $CDDATA/$LIVECDNAME
 cp $VMLINUZ $CDDATA/boot/vmlinuz
 
--- linux-live-5.5.0/initrd/initrd_create	2006-10-17 19:42:57.000000000 +0300
+++ linux-live-5.5.0/initrd/initrd_create	2006-12-21 21:36:56.000000000 +0200
@@ -3,7 +3,7 @@
 #
 # Author:	  Tomas M. <http://www.linux-live.org>
 
-. ../.config || exit 1
+. /etc/linux-live/config || exit 1
 
 if [ "$1" != "" ]; then
    LIVECDNAME="$1"
@@ -20,6 +20,7 @@
 # rcopy is a recursive cp, which copies also symlink's real source
 # $1 = source (may be a regular file or symlink)
 # $2 = target PARENT
+# $3 = optional PREFIX to strip from $1
 #
 rcopy()
 {
@@ -16,7 +17,11 @@
       cp --parent -a "$REALPATH" "$DEST"
       ln -sf "$REALPATH" "$DEST/$SOURCE"
    else
-      cp --parent -a "$SOURCE" "$DEST"
+	  if [ "$3" ]; then
+		  tar ${3:+-C "$3"} -cf - "${1#$3/}" | tar -C "$DEST" -xf -
+	  else
+		  cp --parent -a "$SOURCE" "$DEST"
+	  fi
    fi
    if [ "$?" -ne 0 ]; then
       echo "---------------------------"
@@ -31,12 +36,13 @@
 # copy file/dir only if it exists, else skip with no error
 # $1 = source (may not exist)
 # $2 = target PARENT
+# $3 = optional PREFIX to strip from $1
 #
 rcopy_ex()
 {
    debug "rcopy_ex $1 $2"
    if [ -a "$1" ]; then
-      rcopy "$1" "$2"
+      rcopy "$1" "$2" "$3"
    fi
 }
 
@@ -48,19 +54,13 @@
 ##################################################
 # Create INITRD image now:
 
-MOUNTDIR=/tmp/initrd_mountdir_$$
-INITRD_TREE=/tmp/initrd_tree_$$
+MOUNTDIR=$(mktemp -d || echo /tmp/initrd_mountdir_$$)
+INITRD_TREE=$(mktemp -d || echo /tmp/initrd_tree_$$)
 INITRDIMG=initrd
 
 if [ ! -d $ROOT/$LMK ]; then
    echo "cannot find your kernel modules (*.ko) in $ROOT/$LMK"
    exit 1
 fi
-
-if [ "$(ls -1 rootfs/lib)" = "" ]; then
-   echo "cannot find essential libc libraries."
-   echo "please add ld-linux and libc.so to $(pwd)./rootfs/lib"
-   exit 1
-fi
 
 debug "creating empty directory $INITRD_TREE"
--- linux-live-5.5.0/tools/liblinuxlive	2006-11-28 19:08:09.000000000 +0200
+++ linux-live-5.5.0/tools/liblinuxlive	2006-12-21 21:50:27.000000000 +0200
@@ -367,6 +367,13 @@
    list_partition_devices
 }
 
+# List all network drivers
+#
+list_network_drivers()
+{
+	pcidev /m net
+}
+
 # Find file-path on given device
 # Mounts the device in $1 and returns path if found,
 # else unmounts and exits
@@ -742,11 +742,18 @@
 modprobe_essential_modules()
 {
    debug_log "modprobe_essential_modules" "$*"
+   echolog "Loading PCI modules"
+   for m in $(modules_map pcimap); do
+      modprobe_module $m
+   done
 
    echolog "starting loop device support"
    modprobe_module loop
    echolog "starting cdrom filesystem support"
    modprobe_module isofs
+   modprobe_module sr_mod
+   modprobe_module ide-cd
+   modprobe_module cdrom
    echolog "starting squashfs support"
    modprobe_module squashfs
    echolog "starting aufs support"
@@ -756,6 +756,15 @@
    echolog "starting ntfs support"
    modprobe_module fuse # for ntfs-3g
    modprobe_module ntfs # for ro driver
+
+   echolog "starting xfs support"
+   modprobe_module xfs
+
+   echolog "starting reiserfs support"
+   modprobe_module reiserfs
+
+   echolog "starting ext3 support"
+   modprobe_module ext3
 }
 
 # Modprobe kernel modules needed for USB masstorage devices
@@ -464,6 +493,8 @@
       modprobe_module uhci-hcd
    fi
    modprobe_module usb-storage
+   modprobe_module usbkbd
+   modprobe_module usbhid
 }
 
 # Load drivers for PCMCIA Cardbus devices
@@ -561,6 +593,35 @@
    mdev -s
    echo /bin/mdev > /proc/sys/kernel/hotplug
 }
+
+# create modprobe.conf file $1/etc/modprobe.conf with appropriate ethX module aliases
+# $1 = root directory (union)
+#
+modprobe_update()
+{
+	i=0
+	> $1/etc/modprobe.conf
+	for drv in $(list_network_drivers); do
+		echo "alias eth$i $drv" >> $1/etc/modprobe.conf
+		i=$((i+1))
+	done
+}
+
+# list all pci devices recognized on this system
+# $1 = pcimap | usbmap
+modules_map()
+{
+	t=$1
+	d=/proc/bus/pci/devices
+	k=`uname -r`
+	while read a id b; do
+		v=0x0000${id%????}
+		d=0x0000${id#????}
+		# pci module         vendor     device     subvendor  subdevice  class      class_mask driver_data
+		# nvidia               0x000010de 0xffffffff 0xffffffff 0xffffffff 0x00030200 0xffffffff 0x0
+		echo $v $d
+	done < $d | grep -f /proc/self/fd/0 /lib/modules/$k/modules.$t | awk '{print $1}' | sort -u
+}
 
 # Modprobe kernel modules needed for the LiveCD
 #
--- linux-live-5.5.0/cd-root/boot/isolinux/isolinux.cfg	2006-05-05 23:25:22.000000000 +0300
+++ linux-live-5.5.0/cd-root/boot/isolinux/isolinux.cfg	2006-10-03 14:03:53.000000000 +0300
@@ -7,7 +7,7 @@
 LANEL linux
 MENU LABEL Run linux
 KERNEL /boot/vmlinuz
-APPEND vga=769 initrd=/boot/initrd.gz ramdisk_size=6666 root=/dev/ram0 rw
+APPEND vga=769 initrd=/boot/initrd.gz ramdisk_size=6666 root=/dev/ram0 rw
 
 LABEL memtest
 MENU LABEL Run Memtest utility
--- linux-live-6.1.5/install~	2007-05-14 18:50:44.000000000 +0200
+++ linux-live-6.1.5/install	2007-12-15 22:00:36.196311512 +0100
@@ -15,18 +15,8 @@
 if [ "$N" = "build" ]; then
    N=install
 else
-   . ./.config || exit 1
+   . /etc/linux-live/config || exit 1
    if [ "$1" ]; then ROOT="$1"; fi
 fi
 
-if [ "$N" != "uninstall" ]; then
-   mkdir -p $ROOT/usr/bin
-   mkdir -p $ROOT/usr/lib
-   ls -1 ./tools | egrep -v "^lib" | while read FILE; do cp ./tools/$FILE $ROOT/usr/bin; done
-   cat ./tools/liblinuxlive | sed -r 's/^LIVECDNAME=.*/LIVECDNAME="'$LIVECDNAME'"/' > $ROOT/usr/lib/liblinuxlive
-else
-   ls -1 ./tools | egrep -v "^lib" | while read FILE; do rm -v $ROOT/usr/bin/$FILE; done
-   ls -1 ./tools | egrep "^lib" | while read FILE; do rm -v $ROOT/usr/lib/$FILE; done
-fi
-
-echo "Linux Live scripts were $N""ed successfuly in $1/"
+# No need for installation in PLD
--- linux-live-6.1.5/initrd/initrd_create~	2007-12-16 16:34:01.000000000 +0100
+++ linux-live-6.1.5/initrd/initrd_create	2007-12-16 16:36:21.789095746 +0100
@@ -141,6 +141,7 @@
 ln -s busybox $INITRD_TREE/bin/ls
 ln -s busybox $INITRD_TREE/bin/head
 ln -s busybox $INITRD_TREE/bin/cat
+ln -s busybox $INITRD_TREE/bin/cut
 ln -s busybox $INITRD_TREE/bin/grep
 ln -s busybox $INITRD_TREE/bin/sleep
 ln -s busybox $INITRD_TREE/bin/sed
@@ -152,6 +153,9 @@
 
 # necessary modules and dependency files
 mkdir -p $INITRD_TREE/$LMK/kernel/fs
+rcopy $ROOT/$LMK/kernel/drivers/cdrom $INITRD_TREE
+rcopy $ROOT/$LMK/kernel/drivers/ide $INITRD_TREE
+rcopy $ROOT/$LMK/kernel/drivers/ide/pci $INITRD_TREE
 rcopy $ROOT/$LMK/kernel/fs/aufs $INITRD_TREE
 rcopy $ROOT/$LMK/kernel/fs/squashfs $INITRD_TREE
 
@@ -161,6 +165,7 @@
 rcopy_ex $ROOT/$LMK/kernel/drivers/block/loop.* $INITRD_TREE 2>>$DEBUG
 rcopy_ex $ROOT/$LMK/kernel/fs/fuse/fuse.* $INITRD_TREE 2>>$DEBUG
 
+rcopy_ex $ROOT/$LMK/kernel/fs/exportfs $INITRD_TREE 2>>$DEBUG
 rcopy_ex $ROOT/$LMK/kernel/fs/isofs $INITRD_TREE 2>>$DEBUG
 rcopy_ex $ROOT/$LMK/kernel/fs/fat $INITRD_TREE 2>>$DEBUG
 rcopy_ex $ROOT/$LMK/kernel/fs/vfat $INITRD_TREE 2>>$DEBUG--- linux-live-6.1.5/initrd/linuxrc	2007-09-10 16:44:18.000000000 +0200
@@ -200,44 +200,30 @@
 chmod ago-x $INITRD_TREE/usr.lzm
 rm -Rf $INITRD_TREE/usr/*
 
-debug "creating empty image file for initrd"
-dd if=/dev/zero of=$INITRDIMG bs=1024 count=$RAM0SIZE >>$DEBUG 2>&1
-
-debug "making filesystem"
-mkfs -t ext2 -F -m 0 -b 1024 -i 1024 $INITRDIMG >>$DEBUG 2>&1
-tune2fs -i 120m $INITRDIMG >>$DEBUG 2>&1
-
 debug "creating empty directory $MOUNTDIR"
 rm -Rf $MOUNTDIR
 mkdir $MOUNTDIR
 
-debug "mounting $INITRDIMG to it"
-modprobe loop 2>>$DEBUG
-mount -o loop -t ext2 $INITRDIMG $MOUNTDIR
-if [ "$?" -ne 0 ]; then
-   echo "Error mounting initrd! Not enough free loop devices?"
-   exit 1
-fi
-
 debug "copying content of $INITRD_TREE to $MOUNTDIR"
-rmdir $MOUNTDIR/lost+found
 cp -R --preserve $INITRD_TREE/* $MOUNTDIR 2>/dev/null
 if [ $? -ne 0 ]; then
    debug "error copying data to mounted initrd. Increase RAM0SIZE"
    echo "Not enough free space in initrd. Edit .config and increase RAM0SIZE !"
-   umount $MOUNTDIR
-   rm $INITRDIMG
    exit 1
 fi
 
-debug "unmounting $MOUNTDIR"
-umount $MOUNTDIR
+debug "building $MOUNTDIR"
+CUR=$(pwd)
+cd $MOUNTDIR
+cp linuxrc init
+find . | cpio -H newc -o > "$CUR/$INITRDIMG"
+cd $CUR
 
 debug "gzipping $INITRDIMG"
 gzip --best $INITRDIMG
 
 debug "deleting directory $MOUNTDIR"
-rmdir $MOUNTDIR
+rm -Rf $MOUNTDIR
 
 debug "deleting directory $INITRD_TREE"
 rm -Rf $INITRD_TREE
--- linux-live/initrd/linuxrc	2007-12-16 19:20:07.382382548 +0100
+++ linux-live/initrd/linuxrc	2007-12-16 19:20:07.382382548 +0100
@@ -223,10 +223,10 @@
 cp -fdR /dev .
 
 # find chroot and init
-if [ -x bin/chroot ]; then  CHROOT=/bin/chroot; fi
-if [ -x sbin/chroot ]; then  CHROOT=/sbin/chroot; fi
-if [ -x usr/bin/chroot ]; then  CHROOT=/usr/bin/chroot; fi
-if [ -x usr/sbin/chroot ]; then CHROOT=/usr/sbin/chroot; fi
+if [ -x bin/chroot ]; then  CHROOT=bin/chroot; fi
+if [ -x sbin/chroot ]; then  CHROOT=sbin/chroot; fi
+if [ -x usr/bin/chroot ]; then  CHROOT=usr/bin/chroot; fi
+if [ -x usr/sbin/chroot ]; then CHROOT=usr/sbin/chroot; fi
 if [ "$CHROOT" = "" ]; then fatal "Can't find executable chroot command"; fi
 
 if [ -x bin/init ]; then INIT=bin/init; fi
@@ -238,18 +238,9 @@
 header "linux live end, starting the Linux distribution"
 mount -n -o remount,ro aufs .
 
-# We will copy init from the distro to initrd (there should be 2MB free)
-# This allows us to use the cleanup script during reboot, as init will be
-# started from memory and not from the union and /union will not be busy.
-
-cp -af $INIT /bin
-if [ $? -eq 0 ]; then
-   pivot_root . $INITRAMDISK
-   exec $CHROOT . $INITRAMDISK/bin/init <dev/console >dev/console 2>&1
-else # If copying fails, start init directly.
-   pivot_root . $INITRAMDISK
-   exec $CHROOT . $INIT <dev/console >dev/console 2>&1
-fi
+# Should do switch_root but not supported by this busybox
+pivot_root . $INITRAMDISK
+exec $CHROOT . $INIT <dev/console >dev/console 2>&1
 
 header "!!ERROR!!"
 fatal "You are not supposed to be here, something went wrong!"
